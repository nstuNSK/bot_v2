#!/usr/bin/env python
# -*- coding: utf-8 -*-
# vim:fileencoding=utf-8
import vk_api
import time
import json
import sys
import requests
import database as data
import getter
import keyboards
import api_nstu_news as api
def auth():
    token = getter.get_token()
    print(token)
    vk = vk_api.VkApi(token=token)
    vk._auth_token()
    return vk

def subscribe(type, id):
    if data.get_field(connection=connection, table_name="USERS",select_field = type, field="ID_VK", value=id)[0][0]==False:
        data.set_field(connection = connection, table_name = "USERS", ID_VK = id, field = type, value = "1")
        vk.method("messages.send", {"user_id": id, "message": "–¢–µ–ø–µ—Ä—å —è –±—É–¥—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–±–µ –Ω–æ–≤–æ—Å—Ç–∏! –õ—é–±–ª—é —ç—Ç–æüòç", 'keyboard': key['main_menu']})
    else:
        data.set_field(connection = connection, table_name = "USERS", ID_VK = id, field = type, value = "0")
        vk.method("messages.send", {"user_id": id, "message": "–ù–µ —Ö–æ—á–µ—à—å, –∫–∞–∫ —Ö–æ—á–µ—à—å...\n–ù–æ, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—à—å, —è –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤üí™üèª", 'keyboard': key['main_menu']})

def search_direction(id):
    res = []
    sphere1 = data.get_field(select_field = "SPHERE1",table_name = "USERS",connection= connection,value=id, field="id_vk")[0][0]
    if sphere1 == 0:
        vk.method("messages.send", {"user_id": id, "message": "–ù–æ... –≤–µ–¥—å... —Å—Ñ–µ—Ä—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã... –î–∞–≤–∞–π, –∏—Å–ø—Ä–∞–≤–ª—è–π—Å—èüòä", "keyboard":key['sphere']})
    else:
        res = data.get_field(select_field = "DIRECTION, PROFILE_NAME, FACULT, DESCR, URL",table_name = "DIRECTIONS",connection= connection,value=sphere1, field="SPHERE")
        sphere2 = data.get_field(select_field = "SPHERE2",table_name = "USERS",connection= connection,value=id, field="id_vk")[0][0]
        if sphere2 != 0:
            temp = data.get_field(select_field = "DIRECTION, PROFILE_NAME, FACULT, DESCR, URL",table_name = "DIRECTIONS",connection= connection,value=sphere2, field="SPHERE")
            if temp != 0:
                for item in temp:
                    res.append(item)
            sphere3 = data.get_field(select_field = "SPHERE3",table_name = "USERS",connection= connection,value=id, field="id_vk")[0][0]
            if sphere3 != 0:
                temp = data.get_field(select_field = "DIRECTION, PROFILE_NAME, FACULT, DESCR, URL",table_name = "DIRECTIONS",connection= connection,value=sphere3, field="SPHERE")
                if temp != 0:
                    for item in temp:
                        res.append(item)
        res = list(set(res))
        response = ""
        vk.method("messages.send", {"user_id": id,"message":"–í–æ—Ç —á—Ç–æ —è –Ω–∞—à–µ–ªüôÉ"})
        for item in res:
            if item[1]=='null':
                if item[3]=='null':
                    response = response + "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: " + '"' + item[0] + '"' + " –Ω–∞ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–µ " + item[2]+ "\n" +"–°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: " + item[4]+"\n\n"
                else:
                    response = response + "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: " + '"' + item[0] + '"' + " –Ω–∞ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–µ " + item[2]+ "\n" +item[3] + "\n" +"–°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: " + item[4]+"\n\n"
            else:
                if item[3]=='null':
                    response = response + "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: " + '"' + item[0] + ' (' + item[1] + ')' + '"' + " –Ω–∞ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–µ " + item[2]+ "\n" +"–°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: " + item[4]+"\n\n"
                else:
                    response = response + "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: " + '"' + item[0] + ' (' + item[1] + ')' + '"' + " –Ω–∞ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–µ " + item[2]+ "\n" +item[3] + "\n" +"–°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: " + item[4]+"\n\n"
            if(len(response)>3500):
                vk.method("messages.send", {"user_id": id,"message": response})
                response = ""
        if(response!=""):
            vk.method("messages.send", {"user_id": id,"message": response})
        vk.method("messages.send", {"user_id": id,"message": "–ò—Å–∫–∞–ª –∫–∞–∫ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑üòÇ", 'keyboard': key['main_menu']})


#WAIT_FILLING_POINTS = "-3"
#WAIT_FILLING = "-2"
#TEMP_FILLING = "-1"


def data_processing(id, pay, msg):
    if data.search_field(table_name="USERS",connection=connection,value=id, field="ID_VK")==False:
        data.set_user(table_name="USERS", connection=connection,ID_VK=id)
    
    if pay=={"command":"start"} or pay == "admin":
        vk.method("messages.send", {"user_id": id, "message": "–ü—Ä–∏–≤–µ—Ç, —è –±–æ—Ç –•–≤–∞–Ω‚úãüèª\n \n–ò —è —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –º–∏—Ä–µ –ù–ì–¢–£üòéüòéüòé\n \n–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ù–ì–¢–£ –∏ –æ–±–æ –≤—Å–µ–º, —á—Ç–æ —Å –Ω–∏–º —Å–≤—è–∑–∞–Ω–æüòé\n \n–ü—Ä–∞–≤–¥–∞ —è –ø–æ–∫–∞ –Ω–µ —Å–∞–º—ã–π —É–º–Ω—ã–π –±–æ—Ç, –º–Ω–µ –µ—â–µ —É—á–∏—Ç—å—Å—è –∏ —É—á–∏—Ç—å—Å—è, –ø–æ—ç—Ç–æ–º—É, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—â–∞–π—Å—è —Å–æ –º–Ω–æ–π –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–∑–∞–∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Ç–µ—Ö —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ —è —Å–∞–º –Ω–µ –ø–æ–ø—Ä–æ—à—É –Ω–∞–ø–∏—Å–∞—Ç—å –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å) –∏ —Ç–æ–≥–¥–∞ –≤—Å–µ –±—É–¥–µ—Ç —á–∏–∫–∏-–ø—É–∫–∏üôÉ"})
        vk.method("messages.send", {"user_id": id, "message": "–ò—Ç–∞–∫, —á–µ–º —è –º–æ–≥—É —Ç–µ–±–µ –ø–æ–º–æ—á—å?", "keyboard": key['main_menu']})
    
    elif msg=="admin":
        vk.method("messages.send", {"user_id": id, "message": "–û–ø—è—Ç—å –ø–æ –Ω–æ–≤–æ–π? –ù—É, –ª–∞–¥–Ω–æ...", "keyboard":key['start']})
    
    elif pay=="subscribe":
        vk.method("messages.send", {"user_id": id, "message": "–ö–∞–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç?", "keyboard":key['subscribe']})
    
    elif pay=="enrollee":
        subscribe(type = 'SUB_E', id = id)
    
    elif pay=="schoolchild":
        subscribe(type = 'SUB_S', id = id)
    
    elif pay=="direction_selection":
        vk.method("messages.send", {"user_id": id, "message": " –ê –∫–∞–∫ –ø–æ–¥–æ–±—Ä–∞—Ç—å –Ω–∞–ø—Ä–≤–∞–ª–µ–Ω–∏–µ?", "keyboard":key['direction_selection']})
    
    elif pay=="sphere":
        data.set_field(connection = connection, table_name = "USERS", ID_VK = id, field = "SPHERE1", value = 0)
        data.set_field(connection = connection, table_name = "USERS", ID_VK = id, field = "SPHERE2", value = 0)
        data.set_field(connection = connection, table_name = "USERS", ID_VK = id, field = "SPHERE3", value = 0)
        vk.method("messages.send", {"user_id": id, "message": "–ü–æ–¥—Å–∫–∞–∂–∏ —Å—Ñ–µ—Ä—ã, –∞ —Ç–æ —Ç—É—Ç –º–Ω–æ–≥–æüòä", "keyboard":key['sphere']})
    
    elif pay=="–ú–∞—à–∏–Ω–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ" or pay=="–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å" or pay=="–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞" or pay=="IT-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏" or pay=="–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞" or pay=="–ê–≤–∏–∞—Ü–∏—è" or pay=="–û–±—â–µ—Å—Ç–≤–æ" or pay=="–≠–∫–æ–Ω–æ–º–∏–∫–∞" or pay=="–•–∏–º–∏—è" or pay=="–Ø–∑—ã–∫–∏" or pay=="–§–∏–∑–∏–∫–∞":
        sphere_id = data.get_field(table_name = "SPHERE", connection = connection, select_field = 'SPHERE', field = 'NAME_SPHERE', value = pay)[0][0]
        sphere1 = data.get_field(table_name = "USERS", connection = connection, select_field = 'SPHERE1', field = 'ID_VK', value = id)[0][0]
        if sphere1==0:
            vk.method("messages.send", {"user_id": id, "message": "–î–æ–±–∞–≤–∏–ª! –≠—Ç–æ –±—ã–ª–æ –ª–µ–≥–∫–æüòâ", "keyboard":key['sphere']})
            data.set_field(connection = connection, table_name = 'USERS', ID_VK = id, field = 'SPHERE1', value = sphere_id)
        else:
            sphere2 = data.get_field(table_name = "USERS", connection = connection, select_field = 'SPHERE2', field = 'ID_VK', value = id)[0][0]
            if sphere2 == 0:
                vk.method("messages.send", {"user_id": id, "message": "–ü—Ä–æ—â–µ –ø—Ä–æ—Å—Ç–æ–≥–æ! –î–æ–±–∞–≤–∏–ª!", "keyboard":key['sphere']})
                data.set_field(connection = connection, table_name = 'USERS', ID_VK = id, field = 'SPHERE2', value = sphere_id)
            else:
                sphere3 = data.get_field(table_name = "USERS", connection = connection, select_field = 'SPHERE3', field = 'ID_VK', value = id)[0][0]
                if sphere3 == 0:
                    vk.method("messages.send", {"user_id": id, "message": "–ò–∑–∏ –¥–æ–±–∞–≤–∏–ª!", "keyboard":key['sphere']})
                    data.set_field(connection = connection, table_name = 'USERS', ID_VK = id, field = 'SPHERE3', value = sphere_id)
                    search_direction(id)
        
   
    elif pay == "search":
        search_direction(id = id)
    elif pay == "name_dir":
        vk.method("messages.send", {"user_id": id, "message": "–ú–µ–Ω—è –ø–æ–∫–∞ —á—Ç–æ —ç—Ç–æ–º—É –Ω–µ –Ω–∞—É—á–∏–ª–∏üòû\n–ù–æ —Å–æ–≤—Å–µ–º —Å–∫–æ—Ä–æ –Ω–∞—É—á–∞—Ç, –æ–±–µ—â–∞—é!", "keyboard": key['main_menu']})
    elif pay == "lists":
        vk.method("messages.send", {"user_id": id, "message": "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é:", "keyboard": key['list']})
    
    elif pay == "lk_code":
        vk.method("messages.send", {"user_id": id, "message": "–ú–µ–Ω—è –ø–æ–∫–∞ —á—Ç–æ —ç—Ç–æ–º—É –Ω–µ –Ω–∞—É—á–∏–ª–∏üòû\n–ù–æ —Å–æ–≤—Å–µ–º —Å–∫–æ—Ä–æ –Ω–∞—É—á–∞—Ç, –æ–±–µ—â–∞—é!", "keyboard": key['main_menu']})
    
    elif pay == "frequency":
        vk.method("messages.send", {"user_id": id, "message": "–ú–µ–Ω—è –ø–æ–∫–∞ —á—Ç–æ —ç—Ç–æ–º—É –Ω–µ –Ω–∞—É—á–∏–ª–∏üòû\n–ù–æ —Å–æ–≤—Å–µ–º —Å–∫–æ—Ä–æ –Ω–∞—É—á–∞—Ç, –æ–±–µ—â–∞—é!", "keyboard": key['main_menu']})
        #vk.method("messages.send", {"user_id": id, "message": "–ö–∞–∫ —á–∞—Å—Ç–æ –º–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–±–µ –Ω–æ–≤–æ—Å—Ç–∏?", "keyboard": key['frequency']})
    
    elif msg == "–ë—É!":
        vk.method("messages.send", {"user_id": id, "message": "–ê–∞–∞–∞!"})
        vk.method("messages.send", {"user_id": id, "message": "–ê, —ç—Ç–æ —Ç—ãüòÉ"})
        vk.method("messages.send", {"user_id": id, "message": "–ù–µ –ø—É–≥–∞–π –º–µ–Ω—è —Ç–∞–∫ –±–æ–ª—å—à–µüôèüèª", "keyboard": key['main_menu']})
    else:
        vk.method("messages.send", {"user_id": id, "message": "–Ø —Ç–µ–±—è –Ω–µ –ø–æ–Ω–∏–º–∞—éüòî\n–ò—Å–ø–æ–ª—å–∑—É–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–ª–∞–≤–∏–∞—Ç—É—Ä—Éüôèüèª", "keyboard": key['main_menu']})
def get_msg():
    while True:
        try:
            messages = vk.method("messages.getConversations", {"offset": 0, "count": 100, "filter": "unanswered"})
            if messages["count"] >= 1:
                id = messages["items"][0]["last_message"]["from_id"]
                msg = messages["items"][0]["last_message"]["text"]
                if "payload" in messages["items"][0]["last_message"]:
                    pay = messages["items"][0]["last_message"]["payload"][1:-1]
                    try:
                        pay = bytes(pay, 'cp1251').decode('utf-8')
                    except ValueError:
                        pass
                    finally:
                        print(pay)
                else:
                    pay = "0"
                    print(msg)
                data_processing(id=id, pay=pay, msg=msg)
        except Exception:
            time.sleep(0.1)
                 
key = keyboards.get_keyboards() 

vk = auth()
print(vk)  
connection = data.connect()
print(connection)
get_msg()